var BUBBLE_BORDER,BUBBLE_RADIUS,CONTAINER_BORDER,MAX_ANGLE,SPEED,bubbleMatrix,bubbleMatrixOne,bubbleMatrixTwo,checkCluster,currMatrix,drop,findClosestInMatrix,gameover,getColor,getDivFromLoc,getPointAtT,getPointAtY,getSlope,isMatrixLocEmpty,lookAround,moveBubble,scoochAllDown,shooting,stringifyLoc,toggleMatrixPosition;BUBBLE_BORDER=5,BUBBLE_RADIUS=25,CONTAINER_BORDER=5,SPEED=20,MAX_ANGLE=75,bubbleMatrix=[],bubbleMatrixOne=[],bubbleMatrixTwo=[],currMatrix="",shooting=!1,gameover=!1,$(document).ready(function(){var t,o,r,e,n,a,i,u,l,b,p,s,c,h,d,x,M,m;for(b=$("<div class='popper-shooter'></div>"),s=$("<div id='shooter-control'></div>"),p=$("<div id='shooter-base'></div>"),c=$("<div id='shooter-control-overlay'></div>"),e=$("<div id='gameover'></div>"),e.append("<div style='color: #300; text-align: center; font-size: 60px; margin-top: 200px'><strong>Game Over <i class='fa fa-frown-o'></i></strong></div>"),$("#popper-container").append(s),$("#popper-container").append(p),$("#popper-container").append(c),$("#popper-container").append(e),$("#popper-container").append(b),t=["red","green","yellow","blue"],l=Math.floor(Math.random()*t.length),o=t[l],r="popper-"+o,$(".popper-shooter").addClass(r),c.mousemove(function(t){var o;gameover||(o=(t.pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,o=Math.max(-MAX_ANGLE,o),o=Math.min(MAX_ANGLE,o),$(".popper-shooter").data("rotatedeg",o),$(".popper-shooter").css("transform","rotate("+o+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*o)/10))}),c.bind("touchmove",function(t){var o;gameover||(t.preventDefault(),o=(t.originalEvent.touches[0].pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,o=Math.max(-MAX_ANGLE,o),o=Math.min(MAX_ANGLE,o),$(".popper-shooter").data("rotatedeg",o),$(".popper-shooter").css("transform","rotate("+o+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*o)/10))}),c.click(function(){var e,n;if(!shooting&&!gameover){for(n=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*n)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",o).shoot(n),e=0;e<t.length;)$(".popper-shooter").removeClass("popper-"+t[e]),e++;l=Math.floor(Math.random()*t.length),o=t[l],r="popper-"+o,$(".popper-shooter").addClass(r)}}),c.bind("touchend",function(e){var n,a;if(!shooting&&!gameover){for(e.preventDefault(),a=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*a)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",o).shoot(a),n=0;n<t.length;)$(".popper-shooter").removeClass("popper-"+t[n]),n++;l=Math.floor(Math.random()*t.length),o=t[l],r="popper-"+o,$(".popper-shooter").addClass(r)}}),h=$("#popper-container").width(),n=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,x=Math.floor(h/(2*BUBBLE_RADIUS)-.5),m=1.5*Math.floor(n/(2*BUBBLE_RADIUS)-.5)-1,u=(h-(x+.5)*BUBBLE_RADIUS*2)/2,bubbleMatrixOne=[],bubbleMatrix=[],i=0;m>i;){for(bubbleMatrixOne[i]=[],bubbleMatrix[i]=[],a=0;x>a;)i%2===0?(d=a*BUBBLE_RADIUS*2+u,M=n):d=a*BUBBLE_RADIUS*2+BUBBLE_RADIUS+u,M=n-BUBBLE_RADIUS*i*1.7,bubbleMatrixOne[i][a]={x:d,y:M},bubbleMatrix[i][a]={x:d,y:M},a++;i++}for(currMatrix="one",bubbleMatrixTwo=[],i=0;m>i;){for(bubbleMatrixTwo[i]=[],a=0;x>a;)i%2===1?(d=a*BUBBLE_RADIUS*2+u,M=n):d=a*BUBBLE_RADIUS*2+BUBBLE_RADIUS+u,M=n-BUBBLE_RADIUS*i*1.7,bubbleMatrixTwo[i][a]={x:d,y:M},a++;i++}}),toggleMatrixPosition=function(){var t,o,r,e;for(console.log("old",currMatrix),"one"===currMatrix?(t=bubbleMatrixTwo,currMatrix="two"):(t=bubbleMatrixOne,currMatrix="one"),e=0;e<t.length;){for(r=0;r<t[e].length;)bubbleMatrix[e][r].x=t[e][r].x,bubbleMatrix[e][r].y=t[e][r].y,isMatrixLocEmpty({row:e,num:r})||(o=$(".point[data-matrow='"+e+"'][data-matnum='"+r+"']"),o.css("left",t[e][r].x+"px").css("bottom",t[e][r].y)),r++;e++}console.log("new",currMatrix)},getSlope=function(t){var o,r,e;return o=90-Math.abs(t),r=o*Math.PI/180,e=Math.tan(r)},getPointAtT=function(t,o){var r,e,n,a,i,u,l;return i=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,n=getSlope(o),u=t/Math.pow(1+n*n,.5),l=u*n,0===o?(u=0,l=t):(r=Math.ceil((u+i/2)/i),e=2*Math.floor((u/i+.5)/2),r%2===1?u-=i*e:u=i-(u-i*e),0>o&&(u=-u)),u+=i/2,l-=BUBBLE_RADIUS,a={x:u,y:l}},getPointAtY=function(t,o){var r,e,n,a;return n=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,r=getSlope(o),a=t/r,e=a*Math.pow(1+r*r,.5),getPointAtT(e,o)},findClosestInMatrix=function(t,o){var r,e,n,a,i,u;for(n=5e3,i={x:"",y:""},a={row:"",num:""},r=0;r<bubbleMatrix.length;){for(e=0;e<bubbleMatrix[0].length;)u=Math.pow(Math.pow(bubbleMatrix[r][e].x-t,2)+Math.pow(bubbleMatrix[r][e].y-o,2),.5),n>u&&(i.x=bubbleMatrix[r][e].x,i.y=bubbleMatrix[r][e].y,a.row=r,a.num=e,n=u),e++;r++}return a},scoochAllDown=function(t){var o;for(o=bubbleMatrix.length;o>0;)for(o--,t=bubbleMatrix[o].length;t>0;)t--,isMatrixLocEmpty({row:o,num:t})||moveBubble({row:o,num:t},{row:o+1,num:t});return toggleMatrixPosition()},moveBubble=function(t,o){var r;return r=getDivFromLoc(t),r.attr("data-matrow",o.row).attr("data-matnum",o.num),r.css("bottom",bubbleMatrix[o.row][o.num].y),r.css("left",bubbleMatrix[o.row][o.num].x),r.text(o.row+","+o.num),bubbleMatrix[o.row][o.num].div=bubbleMatrix[t.row][t.num].div,bubbleMatrix[o.row][o.num].color=bubbleMatrix[t.row][t.num].color,bubbleMatrix[t.row][t.num].div=void 0,bubbleMatrix[t.row][t.num].color=void 0},checkCluster=function(t,o,r,e){var n,a,i,u,l;if(void 0===o&&(o=!0),void 0===r?r=0:r++,void 0===e&&(e=[]),e.push(stringifyLoc(t)),n=[t],1e3>r){for(a=lookAround(t),u=0,l=a.length;l>u;u++)i=a[u],-1===$.inArray(stringifyLoc(i),e)&&(e.push(stringifyLoc(i)),o?getColor(i)===getColor(t)&&(n=n.concat(checkCluster(i,o,r,e))):n=n.concat(checkCluster(i,o,r,e)));return n}return console.log("too many recursions")},isMatrixLocEmpty=function(t){return t.row<0||t.row>bubbleMatrix.length-1||t.num<0||t.num>bubbleMatrix[0].length-1?!0:void 0===bubbleMatrix[t.row][t.num].div},stringifyLoc=function(t){return t.row+","+t.num},getColor=function(t,o){return void 0===t.row?bubbleMatrix[t][o].color:bubbleMatrix[t.row][t.num].color},lookAround=function(t){var o,r,e,n,a,i,u,l,b;for(r=$(this[0]),u=t.row,i=t.num,e=[],o=u%2===0?-1:0,e.push({row:u-1,num:i+o}),e.push({row:u-1,num:i+o+1}),e.push({row:u,num:i-1}),e.push({row:u,num:i+1}),e.push({row:u+1,num:i+o}),e.push({row:u+1,num:i+o+1}),n=[],l=0,b=e.length;b>l;l++)a=e[l],isMatrixLocEmpty(a)||n.push(a);return n},drop=function(t,o,r){var e,n,a,i,u,l,b,p;for(t=t instanceof Array?t:[t],u=_.min(t,function(t){return t.row}),l=u.row,b=0,p=t.length;p>b;b++)n=t[b],bubbleMatrix[n.row][n.num].color=void 0,bubbleMatrix[n.row][n.num].div=void 0,a=getDivFromLoc(n),e=parseInt(a.css("bottom")),i=(e-$("#popper-container").height())*(3*(n.row-u.row+1)+1),"drop"===o?a.animate({bottom:i+"px"},{duration:600,complete:function(){return void 0!==r?r():void 0}}):a.fadeOut({duration:150,complete:function(){return void 0!==r?setTimeout(function(){return r()},10):void 0}})},getDivFromLoc=function(t){var o;return o=$(".point[data-matrow="+t.row+"][data-matnum="+t.num+"]")},jQuery.fn.createBubble=function(){var t;return t=$("<div class='point'></div>"),t.css("width",2*BUBBLE_RADIUS+"px").css("height",2*BUBBLE_RADIUS+"px").css("border-width",BUBBLE_BORDER+"px"),$(this[0]).append(t),t},jQuery.fn.putInMatrix=function(t){var o,r,e;r=$(this[0]),bubbleMatrix[t.row][t.num].div=r,bubbleMatrix[t.row][t.num].color=r.attr("data-color"),o=bubbleMatrix[t.row][t.num],r.drawAt(o.x,o.y),r.attr("data-matrow",t.row),r.attr("data-matnum",t.num),r.text(t.row+", "+t.num),e=checkCluster(t,!0),e.length>=3?drop(e,"fade",function(){var t,o,r,e,n,a,i,u,l,b,p,s,c,h,d;for(p=[],r=0,d=bubbleMatrix[0],c=0,h=d.length;h>c;c++)t=d[c],p.push(r),r++;for(s=[],r=0;r<p.length&&1e3>r;)n={row:0,num:r},isMatrixLocEmpty(n)?r++:(s=s.concat(checkCluster(n,!1)),o=_.max(_.where(s,{row:0}),function(t){return t.num}),r=o.num+1);for(a=[],b=0;b<bubbleMatrix.length;){for(i=0;i<bubbleMatrix[b].length;)e={row:b,num:i},isMatrixLocEmpty(e)||0===_.where(s,e).length&&a.push(e),i++;b++}return drop(a,"drop"),l=parseInt($("#score").text()),u=l+a.length,$("#score").text(u)}):t.row>10&&($("#gameover").show(),gameover=!0,r=$(".point").last(),r.css("background-color","#DDD").css("border-color","#BBB"),r.putInMatrix(prevMatrixLoc),shooting=!1),shooting=!1},jQuery.fn.drawAt=function(t,o){$(this[0]).show().css("bottom",o+"px").css("left",+t+"px")},jQuery.fn.shoot=function(t){var o,r,e,n,a;return r=$(this[0]),clearInterval(window.shootInterval),n={row:"",num:""},e=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,a=0,o=0,window.shootInterval=setInterval(function(){var i,u,l;shooting=!0,l=getPointAtT(a,t),l.y<=e?(u=findClosestInMatrix(l.x,l.y),isMatrixLocEmpty(u)?(o%2===0&&r.drawAt(l.x,l.y),n=u,a+=SPEED):(clearInterval(window.shootInterval),r.putInMatrix(n))):(clearInterval(window.shootInterval),i=getPointAtY(e+BUBBLE_RADIUS,t),u=findClosestInMatrix(i.x,i.y),r.putInMatrix(isMatrixLocEmpty(u)?u:n))},5),r};