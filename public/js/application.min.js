var ADDROW_TIMER_CEILING,ADDROW_TIMER_MIN,ADDROW_TIMER_MULTIPLIER,BUBBLE_BORDER,BUBBLE_OPTIONS,BUBBLE_RADIUS,CONTAINER_BORDER,DEFAULT_ROWS,DROP_MULTIPLER,DROP_TIME_MULTIPLER,MAX_ANGLE,MAX_ROW_NUM,ROW_TURNS_CEILING,ROW_TURNS_FLOOR,ROW_TURNS_MULTIPLIER,ROW_TURNS_RAND,SPEED,addRow,addRowCounter,addRowCounterSecs,addRows,addToScore,bubbleMatrix,bubbleMatrixOne,bubbleMatrixTwo,checkCluster,checkIfWon,currMatrix,drop,findClosestInMatrix,gameOver,getColor,getDivFromLoc,getPointAtT,getPointAtY,getSlope,getUrlParam,isGameOver,isMatrixLocEmpty,isPaused,isWon,lookAround,moveBubble,noticeFlash,numRowAdded,pause,scoochAllDown,shooting,stringifyLoc,toggleMatrixPosition,unpause,win;BUBBLE_BORDER=5,BUBBLE_RADIUS=25,CONTAINER_BORDER=5,BUBBLE_OPTIONS=["red","green","yellow","blue"],DEFAULT_ROWS=3,MAX_ROW_NUM=10,SPEED=20,MAX_ANGLE=75,ROW_TURNS_CEILING=0,ROW_TURNS_FLOOR=2,ROW_TURNS_RAND=1,ROW_TURNS_MULTIPLIER=.8,ADDROW_TIMER_CEILING=20,ADDROW_TIMER_MIN=3,ADDROW_TIMER_MULTIPLIER=.9,DROP_MULTIPLER=1.2,DROP_TIME_MULTIPLER=1,getUrlParam=function(t){var r,o;return t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),r=new RegExp("[\\?&]"+t+"=([^&#]*)"),o=r.exec(location.search),null==o?"":decodeURIComponent(o[1].replace(/\+/g," ").replace(/\//g,""))},""!==getUrlParam("maxrows")&&(MAX_ROW_NUM=parseFloat(getUrlParam("maxrows"))),""!==getUrlParam("startrows")&&(DEFAULT_ROWS=parseFloat(getUrlParam("startrows"))),""!==getUrlParam("speed")&&(SPEED=parseFloat(getUrlParam("speed"))),""!==getUrlParam("angle")&&(MAX_ANGLE=parseFloat(getUrlParam("angle"))),""!==getUrlParam("turnmax")&&(ROW_TURNS_CEILING=parseFloat(getUrlParam("turnmax"))),""!==getUrlParam("turnmin")&&(ROW_TURNS_FLOOR=parseFloat(getUrlParam("turnmin"))),""!==getUrlParam("turnrand")&&(ROW_TURNS_RAND=parseFloat(getUrlParam("turnrand"))),""!==getUrlParam("turnaccel")&&(ROW_TURNS_MULTIPLIER=parseFloat(getUrlParam("turnaccel"))),""!==getUrlParam("timermax")&&(ADDROW_TIMER_CEILING=parseFloat(getUrlParam("timermax"))),""!==getUrlParam("timermin")&&(ADDROW_TIMER_MIN=parseFloat(getUrlParam("timermin"))),""!==getUrlParam("timeraccel")&&(ADDROW_TIMER_MULTIPLIER=parseFloat(getUrlParam("timeraccel"))),""!==getUrlParam("droppoints")&&(DROP_MULTIPLER=parseFloat(getUrlParam("droppoints"))),""!==getUrlParam("droptime")&&(DROP_TIME_MULTIPLER=parseFloat(getUrlParam("droptime"))),shooting=!1,isGameOver=!1,isPaused=!0,isWon=!1,currMatrix="",bubbleMatrix=[],bubbleMatrixOne=[],bubbleMatrixTwo=[],addRowCounter=0,addRowCounterSecs=1,numRowAdded=0,$(document).ready(function(){var t,r,o,e,a,n,i,u,s,d,l,p,c,R,b,h,M,m,_,I,w,E,B,U,g,x;for(h=$("<div class='popper-shooter'></div>"),m=$("<div id='shooter-control'></div>"),M=$("<div id='shooter-base'></div>"),0!==ROW_TURNS_CEILING?(o=0!==ROW_TURNS_MULTIPLIER?"<br>...for now":"",s=1!==ROW_TURNS_RAND?Math.ceil(ROW_TURNS_CEILING/ROW_TURNS_RAND)+" to ":"",R="New row every "+s+ROW_TURNS_CEILING+" turns"+o+".<br><br>"):R="",0!==ADDROW_TIMER_CEILING?(o=1>ADDROW_TIMER_MULTIPLIER?"<br>...for now":"",b="New row every "+ADDROW_TIMER_CEILING+" secs"+o+".<br><br>"):b="",I=$("<div id='startscreen' class='overlay'></div>"),I.append("<p>Clear the board.<br /><br />\nConnect 3 or more of the similar colors to POP them.<br /><br /> "+R+b+'<button class="btn btn-primary btn-large" id="startplaying">Start Playing</button></p>'),e=$("<div id='gameover' class='overlay'></div>"),e.append("<p>Game Over <i class='fa fa-frown-o'></i></p>"),l=$("<div id='pause' class='overlay'></div>"),l.append("<p>Paused. o_O</p>"),E=$("<div id='victory' class='overlay'></div>"),E.append("<p>VICTORY! <i class='fa fa-smile-o'></p>"),d=$("<div id='notice-overlay'></div>"),_=$("<div id='shooter-control-overlay'></div>"),$("#popper-container").append(m),$("#popper-container").append(M),$("#popper-container").append(_),$("#popper-container").append(e),$("#popper-container").append(l),$("#popper-container").append(E),$("#popper-container").append(h),$("#popper-container").append(d),$("#popper-container").append(I),p=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t=BUBBLE_OPTIONS[p],r="popper-"+t,$(".popper-shooter").addClass(r),_.mousemove(function(t){var r;isGameOver||isPaused||isWon||(r=(t.pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,r=Math.max(-MAX_ANGLE,r),r=Math.min(MAX_ANGLE,r),$(".popper-shooter").data("rotatedeg",r),$(".popper-shooter").css("transform","rotate("+r+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*r)/10))}),_.bind("touchmove",function(t){var r;isGameOver||isPaused||isWon||(t.preventDefault(),r=(t.originalEvent.touches[0].pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,r=Math.max(-MAX_ANGLE,r),r=Math.min(MAX_ANGLE,r),$(".popper-shooter").data("rotatedeg",r),$(".popper-shooter").css("transform","rotate("+r+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*r)/10))}),_.click(function(){var o,e;if(!(shooting||isGameOver||isPaused||isWon)){for(e=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*e)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",t).shoot(e),0!==ROW_TURNS_CEILING&&(addRowCounter+=Math.floor(Math.random()*ROW_TURNS_RAND)+1,addRowCounter>=Math.max(ROW_TURNS_FLOOR,ROW_TURNS_CEILING-ROW_TURNS_MULTIPLIER*numRowAdded)&&(addRow(),numRowAdded++,addRowCounter=0)),o=0;o<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[o]),o++;p=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t=BUBBLE_OPTIONS[p],r="popper-"+t,$(".popper-shooter").addClass(r)}}),_.bind("touchend",function(o){var e,a;if(!(shooting||isGameOver||isPaused||isWon)){for(o.preventDefault(),a=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*a)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",t).shoot(a),0!==ROW_TURNS_CEILING&&(addRowCounter+=Math.floor(Math.random()*ROW_TURNS_RAND)+1,addRowCounter>ROW_TURNS_CEILING-ROW_TURNS_MULTIPLIER*numRowAdded&&(addRow(),numRowAdded++,addRowCounter=0)),e=0;e<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[e]),e++;return p=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t=BUBBLE_OPTIONS[p],r="popper-"+t,$(".popper-shooter").addClass(r)}}),w=$("#popper-container").width(),a=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,U=Math.floor(w/(2*BUBBLE_RADIUS)-.5),x=1.5*Math.floor(a/(2*BUBBLE_RADIUS)-.5)-1,u=(w-(U+.5)*BUBBLE_RADIUS*2)/2,bubbleMatrixOne=[],bubbleMatrix=[],i=0;x>i;){for(bubbleMatrixOne[i]=[],bubbleMatrix[i]=[],n=0;U>n;)i%2===0?(B=n*BUBBLE_RADIUS*2+u,g=a):B=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+u,g=a-BUBBLE_RADIUS*i*1.7,bubbleMatrixOne[i][n]={x:B,y:g},bubbleMatrix[i][n]={x:B,y:g},n++;i++}for(currMatrix="one",bubbleMatrixTwo=[],i=0;x>i;){for(bubbleMatrixTwo[i]=[],n=0;U>n;)i%2===1?(B=n*BUBBLE_RADIUS*2+u,g=a):B=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+u,g=a-BUBBLE_RADIUS*i*1.7,bubbleMatrixTwo[i][n]={x:B,y:g},n++;i++}return 0===ADDROW_TIMER_CEILING?($("#timer-container").hide(),addRowCounterSecs=1):($("#timer-container").show(),$("#addrowmeter").css("width","100%"),$("#timer").text(ADDROW_TIMER_CEILING).show(),addRowCounterSecs=ADDROW_TIMER_CEILING,c=.1,window.addrow=setInterval(function(){return isPaused===!1?($("#timer").text(Math.max(0,Math.ceil(addRowCounterSecs))),$("#addrowmeter").css("width",(addRowCounterSecs-1*c)/ADDROW_TIMER_CEILING*100+"%"),0>addRowCounterSecs&&(addRow(),numRowAdded++,addRowCounterSecs=Math.max(ADDROW_TIMER_MIN,ADDROW_TIMER_CEILING*Math.pow(ADDROW_TIMER_MULTIPLIER,numRowAdded)),console.log(addRowCounterSecs)),addRowCounterSecs-=1*c):void 0},1e3*c)),addRows(DEFAULT_ROWS),$("#pause-button").click(function(){return isPaused===!1?(pause(),$(this).text("Go")):(unpause(),$(this).text("Pause"))}),$("#startplaying").click(function(){return $("#startscreen").hide(),unpause(),$("#popper-container").css("cursor","none")})}),noticeFlash=function(t){return $("#notice-overlay").html(t).show().fadeOut({duration:1500})},getSlope=function(t){var r,o,e;return r=90-Math.abs(t),o=r*Math.PI/180,e=Math.tan(o)},getPointAtT=function(t,r){var o,e,a,n,i,u,s;return i=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,a=getSlope(r),u=t/Math.pow(1+a*a,.5),s=u*a,0===r?(u=0,s=t):(o=Math.ceil((u+i/2)/i),e=2*Math.floor((u/i+.5)/2),o%2===1?u-=i*e:u=i-(u-i*e),0>r&&(u=-u)),u+=i/2,s-=BUBBLE_RADIUS,n={x:u,y:s}},getPointAtY=function(t,r){var o,e,a,n;return a=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,o=getSlope(r),n=t/o,e=n*Math.pow(1+o*o,.5),getPointAtT(e,r)},findClosestInMatrix=function(t,r){var o,e,a,n,i,u;for(a=5e3,i={x:"",y:""},n={row:"",num:""},o=0;o<bubbleMatrix.length;){for(e=0;e<bubbleMatrix[0].length;)u=Math.pow(Math.pow(bubbleMatrix[o][e].x-t,2)+Math.pow(bubbleMatrix[o][e].y-r,2),.5),a>u&&(i.x=bubbleMatrix[o][e].x,i.y=bubbleMatrix[o][e].y,n.row=o,n.num=e,a=u),e++;o++}return n},addRows=function(t){var r,o;for(r=0,o=[];t>r;)addRow(),o.push(r++);return o},addRow=function(t){var r,o,e,a,n,i,u,s,d,l,p,c;if(scoochAllDown(),void 0===t)for(t=[],p=bubbleMatrix[0],u=0,d=p.length;d>u;u++)e=p[u],i=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t.push(BUBBLE_OPTIONS[i]);else if(t.length<bubbleMatrix[0].length)for(e=t.length;e<bubbleMatrix[0].length;)i=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t.push(BUBBLE_OPTIONS[i]),e++;for(n=0,c=[],s=0,l=t.length;l>s;s++)r=t[s],o=$("#popper-container").createBubble(r).addClass("popper-"+r).text("0,"+n),a={row:0,num:n},o.putInMatrix(a,!1),o.hide().fadeIn({duration:200}),c.push(n++);return c},scoochAllDown=function(t){var r,o,e;for(r=0,o=!1,e=bubbleMatrix.length;e>0;)for(e--,t=bubbleMatrix[e].length;t>0;)t--,isMatrixLocEmpty({row:e,num:t})||(moveBubble({row:e,num:t},{row:e+1,num:t}),o===!1&&(o=!0,r=e+1));return toggleMatrixPosition(),r>MAX_ROW_NUM?gameOver():void 0},moveBubble=function(t,r){var o;return o=getDivFromLoc(t),o.attr("data-matrow",r.row).attr("data-matnum",r.num),o.css("bottom",bubbleMatrix[r.row][r.num].y),o.css("left",bubbleMatrix[r.row][r.num].x),o.text(r.row+","+r.num),bubbleMatrix[r.row][r.num].div=bubbleMatrix[t.row][t.num].div,bubbleMatrix[r.row][r.num].color=bubbleMatrix[t.row][t.num].color,bubbleMatrix[t.row][t.num].div=void 0,bubbleMatrix[t.row][t.num].color=void 0},toggleMatrixPosition=function(){var t,r,o,e;for("one"===currMatrix?(t=bubbleMatrixTwo,currMatrix="two"):(t=bubbleMatrixOne,currMatrix="one"),e=0;e<t.length;){for(o=0;o<t[e].length;)bubbleMatrix[e][o].x=t[e][o].x,bubbleMatrix[e][o].y=t[e][o].y,isMatrixLocEmpty({row:e,num:o})||(r=$(".point[data-matrow='"+e+"'][data-matnum='"+o+"']"),r.css("left",t[e][o].x+"px").css("bottom",t[e][o].y)),o++;e++}},checkCluster=function(t,r,o,e){var a,n,i,u,s;if(void 0===r&&(r=!0),void 0===o?o=0:o++,void 0===e&&(e=[]),e.push(stringifyLoc(t)),a=[t],1e3>o){for(n=lookAround(t),u=0,s=n.length;s>u;u++)i=n[u],-1===$.inArray(stringifyLoc(i),e)&&(e.push(stringifyLoc(i)),r?getColor(i)===getColor(t)&&(a=a.concat(checkCluster(i,r,o,e))):a=a.concat(checkCluster(i,r,o,e)));return a}},isMatrixLocEmpty=function(t){return t.row<0||t.row>bubbleMatrix.length-1||t.num<0||t.num>bubbleMatrix[0].length-1?!0:void 0===bubbleMatrix[t.row][t.num].div},stringifyLoc=function(t){return t.row+","+t.num},getColor=function(t,r){return void 0===t.row?bubbleMatrix[t][r].color:bubbleMatrix[t.row][t.num].color},lookAround=function(t){var r,o,e,a,n,i,u,s,d;for(o=$(this[0]),u=t.row,i=t.num,e=[],r="one"===currMatrix?u%2===0?-1:0:u%2===1?-1:0,e.push({row:u-1,num:i+r}),e.push({row:u-1,num:i+r+1}),e.push({row:u,num:i-1}),e.push({row:u,num:i+1}),e.push({row:u+1,num:i+r}),e.push({row:u+1,num:i+r+1}),a=[],s=0,d=e.length;d>s;s++)n=e[s],isMatrixLocEmpty(n)||a.push(n);return a},drop=function(t,r,o){var e,a,n,i,u,s,d,l,p,c,R;if(void 0!==t){if(t instanceof Array){if(0===t.length)return;t=t}else t=[t];for("drop"===r&&(p=_.min(t,function(t){return t.row}),d=p.row,l=bubbleMatrix[d][0].y-$("#popper-container").height()),a=0,c=0,R=t.length;R>c;c++)n=t[c],bubbleMatrix[n.row][n.num].color=void 0,bubbleMatrix[n.row][n.num].div=void 0,i=getDivFromLoc(n),"drop"===r?(s=l,u=Math.pow(n.row-d+1,1.1),e=-50*u,s+=e,a===t.length-1?i.animate({bottom:s+"px"},{duration:600,complete:function(){return void 0!==o?o():void 0}}):i.animate({bottom:s+"px"},{duration:600})):i.fadeOut(a===t.length-1?{duration:150,complete:function(){return void 0!==o?setTimeout(function(){return o()},10):void 0}}:{duration:150}),a++}},getDivFromLoc=function(t){var r;return r=$(".point[data-matrow="+t.row+"][data-matnum="+t.num+"]")},gameOver=function(){return $("#gameover").show(),isGameOver=!0,clearInterval(window.addrow),shooting=!1,$("#pause-button").addClass("disabled")},pause=function(){return $("#pause").show(),isPaused=!0},unpause=function(){return $("#pause").hide(),isPaused=!1},win=function(){return $("#victory").show(),clearInterval(window.addrow),isWon=!0,shooting=!1,$("#pause-button").addClass("disabled")},checkIfWon=function(){var t,r,o,e;for(t=!0,e=0;e<bubbleMatrix.length;){for(o=0;o<bubbleMatrix[e].length;){if(r={row:e,num:o},!isMatrixLocEmpty(r)){t=!1;break}o++}e++}return t},addToScore=function(t){var r,o;return o=parseInt($("#score").text()),r=o+t,10>r?$("#score").text("0000"+r):r>=10?$("#score").text("000"+r):r>=100?$("#score").text("00"+r):r>=1e3?$("#score").text("0"+r):r>=1e4?$("#score").text(r):($("#score").text(r),$("#score-container").css("font-size","28px"))},jQuery.fn.createBubble=function(t){var r;return r=$("<div class='point'></div>"),r.css("width",2*BUBBLE_RADIUS+"px").css("height",2*BUBBLE_RADIUS+"px").css("border-width",BUBBLE_BORDER+"px"),void 0!==t&&r.attr("data-color",t),$(this[0]).append(r),r},jQuery.fn.putInMatrix=function(t,r){var o,e,a,n;void 0===r&&(r=!0),a=$(this[0]),bubbleMatrix[t.row][t.num].div=a,bubbleMatrix[t.row][t.num].color=a.attr("data-color"),o=bubbleMatrix[t.row][t.num],a.drawAt(o.x,o.y),a.attr("data-matrow",t.row),a.attr("data-matnum",t.num),a.text(t.row+", "+t.num),r===!0&&(e=0,n=checkCluster(t,!0),n.length>=3?(addToScore(n.length),drop(n,"fade",function(){var t,r,o,e,a,n,i,u,s,d,l,p,c,R,b,h;for(p=[],a=0,h=bubbleMatrix[0],R=0,b=h.length;b>R;R++)t=h[R],p.push(a),a++;for(c=[],a=0;a<p.length&&1e3>a;)i={row:0,num:a},isMatrixLocEmpty(i)?a++:(c=c.concat(checkCluster(i,!1)),e=_.max(_.where(c,{row:0}),function(t){return t.num}),a=e.num+1);for(u=[],l=0;l<bubbleMatrix.length;){for(s=0;s<bubbleMatrix[l].length;)n={row:l,num:s},isMatrixLocEmpty(n)||0===_.where(c,n).length&&u.push(n),s++;l++}return u.length>1&&(o=Math.round(u.length*DROP_TIME_MULTIPLER),d=addRowCounterSecs+o,d=Math.min(d,ADDROW_TIMER_CEILING),addRowCounterSecs=d,$("#addrowmeter").css("width",addRowCounterSecs/ADDROW_TIMER_CEILING*100+"%")),u.length>0?(r=Math.ceil(Math.pow(u.length,DROP_MULTIPLER)),r>1?noticeFlash("<small>Dropped "+u.length+"!</small><br />"+r+" bonus points!!"):1===r&&noticeFlash("<small>Dropped 1</small><br />"+r+" bonus point!")):r=0,addToScore(u.length+r),drop(u,"drop",function(){return checkIfWon()===!0?win():void 0}),checkIfWon()===!0?win():void 0})):t.row>MAX_ROW_NUM&&(gameOver(),a=$(".point").last(),a.css("background-color","#DDD").css("border-color","#BBB"),a.putInMatrix(prevMatrixLoc))),shooting=!1},jQuery.fn.drawAt=function(t,r){$(this[0]).show().css("bottom",r+"px").css("left",+t+"px")},jQuery.fn.shoot=function(t){var r,o,e,a,n;return o=$(this[0]),clearInterval(window.shootInterval),a={row:"",num:""},e=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,n=0,r=0,window.shootInterval=setInterval(function(){var i,u,s;shooting=!0,s=getPointAtT(n,t),s.y<=e?(u=findClosestInMatrix(s.x,s.y),isMatrixLocEmpty(u)?(r%2===0&&o.drawAt(s.x,s.y),a=u,n+=SPEED):(clearInterval(window.shootInterval),o.putInMatrix(a))):(clearInterval(window.shootInterval),i=getPointAtY(e+BUBBLE_RADIUS,t),u=findClosestInMatrix(i.x,i.y),o.putInMatrix(isMatrixLocEmpty(u)?u:a))},5),o};