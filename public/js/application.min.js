var BUBBLE_BORDER,BUBBLE_RADIUS,CONTAINER_BORDER,SPEED,bubbleMatrix,checkCluster,drop,findClosestInMatrix,gameover,getColor,getDivFromLoc,getPointAtT,getPointAtY,getSlope,isMatrixLocEmpty,lookAround,shooting,stringifyLoc;BUBBLE_BORDER=5,BUBBLE_RADIUS=25,CONTAINER_BORDER=5,SPEED=20,bubbleMatrix=[],shooting=!1,gameover=!1,$(document).ready(function(){var o,t,r,e,n,a,i,u,p,s,l,h,c,d,b,B,g;for(s=$("<div class='popper-shooter'></div>"),l=$("<div id='shooter-control'></div>"),h=$("<div id='shooter-control-overlay'></div>"),e=$("<div id='gameover'></div>"),e.append("<div style='color: #300; text-align: center; font-size: 60px; margin-top: 200px'><strong>Game Over <i class='fa fa-frown-o'></i></strong></div>"),$("#popper-container").append(l),$("#popper-container").append(h),$("#popper-container").append(e),$("#popper-container").append(s),o=["red","green","yellow","blue"],p=Math.floor(Math.random()*o.length),t=o[p],r="popper-"+t,$(".popper-shooter").addClass(r),h.mousemove(function(o){var t;gameover||(t=(o.pageX-$(this).offset().left)/$(this).outerWidth()*160-80,$(".popper-shooter").data("rotatedeg",t),$(".popper-shooter").css("transform","rotate("+t+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*t)/10))}),h.bind("touchmove",function(o){var t;gameover||(o.preventDefault(),t=(o.originalEvent.touches[0].pageX-$(this).offset().left)/$(this).outerWidth()*160-80,t=Math.max(-80,t),t=Math.min(80,t),$(".popper-shooter").data("rotatedeg",t),$(".popper-shooter").css("transform","rotate("+t+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*t)/10))}),h.click(function(){var e,n;if(console.log(shooting),!shooting&&!gameover){for(n=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*n)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",t).shoot(n),e=0;e<o.length;)$(".popper-shooter").removeClass("popper-"+o[e]),e++;p=Math.floor(Math.random()*o.length),t=o[p],r="popper-"+t,$(".popper-shooter").addClass(r)}}),h.bind("touchend",function(e){var n,a;if(!shooting&&!gameover){for(e.preventDefault(),a=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*a)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",t).shoot(a),n=0;n<o.length;)$(".popper-shooter").removeClass("popper-"+o[n]),n++;p=Math.floor(Math.random()*o.length),t=o[p],r="popper-"+t,$(".popper-shooter").addClass(r)}}),c=$("#popper-container").width(),n=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,b=Math.floor(c/(2*BUBBLE_RADIUS)-.5),g=1.5*Math.floor(n/(2*BUBBLE_RADIUS)-.5)-1,u=(c-(b+.5)*BUBBLE_RADIUS*2)/2,bubbleMatrix=[],i=0;g>i;){for(bubbleMatrix[i]=[],a=0;b>a;)i%2===0?(d=a*BUBBLE_RADIUS*2+u,B=n):d=a*BUBBLE_RADIUS*2+BUBBLE_RADIUS+u,B=n-BUBBLE_RADIUS*i*1.7,bubbleMatrix[i][a]={x:d,y:B},a++;i++}}),getSlope=function(o){var t,r,e;return t=90-Math.abs(o),r=t*Math.PI/180,e=Math.tan(r)},getPointAtT=function(o,t){var r,e,n,a,i,u,p;return i=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,n=getSlope(t),u=o/Math.pow(1+n*n,.5),p=u*n,0===t?(u=0,p=o):(r=Math.ceil((u+i/2)/i),e=2*Math.floor((u/i+.5)/2),r%2===1?u-=i*e:u=i-(u-i*e),0>t&&(u=-u)),u+=i/2,p-=BUBBLE_RADIUS,a={x:u,y:p}},getPointAtY=function(o,t){var r,e,n,a;return n=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,r=getSlope(t),a=o/r,e=a*Math.pow(1+r*r,.5),getPointAtT(e,t)},findClosestInMatrix=function(o,t){var r,e,n,a,i,u;for(n=5e3,i={x:"",y:""},a={row:"",num:""},r=0;r<bubbleMatrix.length;){for(e=0;e<bubbleMatrix[0].length;)u=Math.pow(Math.pow(bubbleMatrix[r][e].x-o,2)+Math.pow(bubbleMatrix[r][e].y-t,2),.5),n>u&&(i.x=bubbleMatrix[r][e].x,i.y=bubbleMatrix[r][e].y,a.row=r,a.num=e,n=u),e++;r++}return a},checkCluster=function(o,t,r,e){var n,a,i,u,p;if(void 0===t&&(t=!0),void 0===r?r=0:r++,void 0===e&&(e=[]),e.push(stringifyLoc(o)),n=[o],1e3>r){for(a=lookAround(o),u=0,p=a.length;p>u;u++)i=a[u],-1===$.inArray(stringifyLoc(i),e)&&(e.push(stringifyLoc(i)),t?getColor(i)===getColor(o)&&(n=n.concat(checkCluster(i,t,r,e))):n=n.concat(checkCluster(i,t,r,e)));return n}return console.log("too many recursions")},isMatrixLocEmpty=function(o){return o.row<0||o.row>bubbleMatrix.length-1||o.num<0||o.num>bubbleMatrix[0].length-1?!0:void 0===bubbleMatrix[o.row][o.num].div},stringifyLoc=function(o){return o.row+","+o.num},getColor=function(o,t){return void 0===o.row?bubbleMatrix[o][t].color:bubbleMatrix[o.row][o.num].color},lookAround=function(o){var t,r,e,n,a,i,u,p,s;for(r=$(this[0]),u=o.row,i=o.num,e=[],t=u%2===0?-1:0,e.push({row:u-1,num:i+t}),e.push({row:u-1,num:i+t+1}),e.push({row:u,num:i-1}),e.push({row:u,num:i+1}),e.push({row:u+1,num:i+t}),e.push({row:u+1,num:i+t+1}),n=[],p=0,s=e.length;s>p;p++)a=e[p],isMatrixLocEmpty(a)||n.push(a);return n},drop=function(o,t,r){var e,n,a,i,u,p;for(o=o instanceof Array?o:[o],u=0,p=o.length;p>u;u++)n=o[u],bubbleMatrix[n.row][n.num].color=void 0,bubbleMatrix[n.row][n.num].div=void 0,a=getDivFromLoc(n),e=parseInt(a.css("bottom")),i=(e-600)*(3*n.row+1),"drop"===t?a.animate({bottom:i+"px"},{duration:500,complete:function(){return void 0!==r?r():void 0}}):a.fadeOut({duration:100,complete:function(){return void 0!==r?setTimeout(function(){return r()},30):void 0}})},getDivFromLoc=function(o){var t;return t=$(".point[data-matrow="+o.row+"][data-matnum="+o.num+"]")},jQuery.fn.createBubble=function(){var o;return o=$("<div class='point'></div>"),o.css("width",2*BUBBLE_RADIUS+"px").css("height",2*BUBBLE_RADIUS+"px").css("border-width",BUBBLE_BORDER+"px"),$(this[0]).append(o),o},jQuery.fn.putInMatrix=function(o){var t,r,e;r=$(this[0]),bubbleMatrix[o.row][o.num].div=r,bubbleMatrix[o.row][o.num].color=r.attr("data-color"),t=bubbleMatrix[o.row][o.num],r.drawAt(t.x,t.y),r.attr("data-matrow",o.row),r.attr("data-matnum",o.num),r.text(o.row+", "+o.num),e=checkCluster(o,!0),e.length>=3&&drop(e,"fade",function(){var o,t,r,e,n,a,i,u,p,s,l,h,c;for(p=[],r=0,c=bubbleMatrix[0],l=0,h=c.length;h>l;l++)o=c[l],p.push(r),r++;for(s=[],r=0;r<p.length&&1e3>r;)n={row:0,num:r},isMatrixLocEmpty(n)?r++:(s=s.concat(checkCluster(n,!1)),t=_.max(_.where(s,{row:0}),function(o){return o.num}),r=t.num+1,console.log(r));for(a=[],u=0;u<bubbleMatrix.length;){for(i=0;i<bubbleMatrix[u].length;)e={row:u,num:i},isMatrixLocEmpty(e)||0===_.where(s,e).length&&a.push(e),i++;u++}return drop(a,"drop")}),shooting=!1},jQuery.fn.drawAt=function(o,t){$(this[0]).show().css("bottom",t+"px").css("left",+o+"px")},jQuery.fn.shoot=function(o){var t,r,e,n,a;return r=$(this[0]),clearInterval(window.shootInterval),n={row:"",num:""},e=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,a=0,t=0,window.shootInterval=setInterval(function(){var i,u,p;shooting=!0,p=getPointAtT(a,o),p.y<=e?(u=findClosestInMatrix(p.x,p.y),isMatrixLocEmpty(u)?(t%2===0&&r.drawAt(p.x,p.y),n=u,a+=SPEED):(clearInterval(window.shootInterval),n.row>8?($("#gameover").show(),gameover=!0,r.remove(),shooting=!1):r.putInMatrix(n))):(clearInterval(window.shootInterval),i=getPointAtY(e+BUBBLE_RADIUS,o),u=findClosestInMatrix(i.x,i.y),r.putInMatrix(isMatrixLocEmpty(u)?u:n))},5),r};