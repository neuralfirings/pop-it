var ADDROW_TIMER_CEILING,ADDROW_TIMER_MIN,ADDROW_TIMER_MULTIPLIER,BUBBLE_BORDER,BUBBLE_OPTIONS,BUBBLE_RADIUS,CONTAINER_BORDER,DEFAULT_ROWS,DROP_MULTIPLER,DROP_TIME_MULTIPLER,MAX_ANGLE,MAX_ROW_NUM,NUM_PER_ROW,ROW_TURNS_CEILING,ROW_TURNS_FLOOR,ROW_TURNS_MULTIPLIER,ROW_TURNS_RAND,SPEED,addRow,addRowCounter,addRowCounterSecs,addRows,addToScore,addToScrewQueue,auth,autoLogIn,bubbleMatrix,bubbleMatrixOne,bubbleMatrixTwo,checkCluster,checkIfWon,currMatrix,drop,fb,findClosestInMatrix,gameOver,getColor,getDivFromLoc,getPointAtT,getPointAtY,getSlope,getUrlParam,isGameOver,isLoggedIn,isMatrixLocEmpty,isMultiPlayer,isPaused,isWon,lookAround,moveBubble,myPlayerNum,noticeFlash,numRowAdded,pause,scoochAllDown,screwQueue,shooting,stringifyLoc,toggleMatrixPosition,unpause,user,win;NUM_PER_ROW=10,BUBBLE_OPTIONS=["red","green","yellow","blue"],DEFAULT_ROWS=3,MAX_ROW_NUM=10,SPEED=20,MAX_ANGLE=75,ROW_TURNS_CEILING=0,ROW_TURNS_FLOOR=2,ROW_TURNS_RAND=1,ROW_TURNS_MULTIPLIER=.8,ADDROW_TIMER_CEILING=20,ADDROW_TIMER_MIN=3,ADDROW_TIMER_MULTIPLIER=.9,DROP_MULTIPLER=1.2,DROP_TIME_MULTIPLER=1,getUrlParam=function(e){var r,t;return e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),r=new RegExp("[\\?&]"+e+"=([^&#]*)"),t=r.exec(location.search),null==t?"":decodeURIComponent(t[1].replace(/\+/g," ").replace(/\//g,""))},""!==getUrlParam("num")&&(NUM_PER_ROW=parseFloat(getUrlParam("num"))),""!==getUrlParam("maxrows")&&(MAX_ROW_NUM=parseFloat(getUrlParam("maxrows"))),""!==getUrlParam("startrows")&&(DEFAULT_ROWS=parseFloat(getUrlParam("startrows"))),""!==getUrlParam("speed")&&(SPEED=parseFloat(getUrlParam("speed"))),""!==getUrlParam("angle")&&(MAX_ANGLE=parseFloat(getUrlParam("angle"))),""!==getUrlParam("turnmax")&&(ROW_TURNS_CEILING=parseFloat(getUrlParam("turnmax"))),""!==getUrlParam("turnmin")&&(ROW_TURNS_FLOOR=parseFloat(getUrlParam("turnmin"))),""!==getUrlParam("turnrand")&&(ROW_TURNS_RAND=parseFloat(getUrlParam("turnrand"))),""!==getUrlParam("turnaccel")&&(ROW_TURNS_MULTIPLIER=parseFloat(getUrlParam("turnaccel"))),""!==getUrlParam("timermax")&&(ADDROW_TIMER_CEILING=parseFloat(getUrlParam("timermax"))),""!==getUrlParam("timermin")&&(ADDROW_TIMER_MIN=parseFloat(getUrlParam("timermin"))),""!==getUrlParam("timeraccel")&&(ADDROW_TIMER_MULTIPLIER=parseFloat(getUrlParam("timeraccel"))),""!==getUrlParam("droppoints")&&(DROP_MULTIPLER=parseFloat(getUrlParam("droppoints"))),""!==getUrlParam("droptime")&&(DROP_TIME_MULTIPLER=parseFloat(getUrlParam("droptime"))),BUBBLE_BORDER=5,BUBBLE_RADIUS=25,CONTAINER_BORDER=5,shooting=!1,isGameOver=!1,isPaused=!0,isWon=!1,currMatrix="",bubbleMatrix=[],bubbleMatrixOne=[],bubbleMatrixTwo=[],addRowCounter=0,addRowCounterSecs=1,numRowAdded=0,isMultiPlayer=!1,screwQueue=[],myPlayerNum=0,fb=new Firebase("https://pop-it.firebaseio.com/"),user="",isLoggedIn=!1,autoLogIn=!0,auth=new FirebaseSimpleLogin(fb,function(e,r){var t,o;return e?console.log("Firebase error: "+e):r?(user=r,console.log("Anonymouse User "+r.id),o=getUrlParam("m"),""!==o&&(t=fb.child("matches").child(o),t.on("value",function(e){var r,o,a,n;if(null!==e.val()&&(void 0!==e.val().player1&&e.val().player1===user.id?(console.log("You are Player 1!"),isMultiPlayer=!0,$("#startplaying").text("Start Match"),myPlayerNum=1,a=e.val().player2):void 0!==e.val().player2&&e.val().player2===user.id?(console.log("You are Player 2!"),isMultiPlayer=!0,$("#startplaying").text("Start Match"),myPlayerNum=2,a=e.val().player1):void 0===e.val().player2&&(t.child("player2").set(user.id),isMultiPlayer=!0,console.log("You are Player 2!"),$("#startplaying").text("Start Match"),myPlayerNum=2,a=e.val().player1)),isMultiPlayer===!0){for(console.log("game on"),clearInterval(window.addrow),$("#timer-container").hide(),$("#startscreen").find("#rowintervalinfo").hide(),$("#startscreen").find("#rowcounterinfo").hide(),ROW_TURNS_CEILING=0,ADDROW_TIMER_CEILING=0,n=$("<div class='screwqueue-container'><div>Send when full</div></div>"),r=0;NUM_PER_ROW>r;)n.append("<div class='screwqueue-ball screwqueue-"+r+"'></div>"),r++;return $("#popper-container").append(n),o=fb.child("players").child(a).child("boardchange"),o.child("addrow").on("child_added",function(e){return addRow(e.val(),"Your 'friend' sent you a row")})}})),$("#startscreen").css("color","#888")):(autoLogIn&&(console.log("Getting id..."),auth.login("anonymous",{rememberMe:!0})),$("#startscreen").css("color","#888")),$("#startplaying").show()}),$(document).ready(function(){var e,r,t,o,a,n,i,l,u,s,d,c,p,h,b,m,R,M,_,w,I,g,f,E,U,v;for(m=$("<div class='popper-shooter'></div>"),M=$("<div id='shooter-control'></div>"),R=$("<div id='shooter-base'></div>"),0!==ROW_TURNS_CEILING?(t=0!==ROW_TURNS_MULTIPLIER?"<br>...for now":"",u=1!==ROW_TURNS_RAND?Math.ceil(ROW_TURNS_CEILING/ROW_TURNS_RAND)+" to ":"",h="<span id='rowcounterinfo'>New row every "+u+ROW_TURNS_CEILING+" turns"+t+".<br><br></span>"):h="",0!==ADDROW_TIMER_CEILING?(t=1>ADDROW_TIMER_MULTIPLIER?"<br>...for now":"",b="<span id='rowintervalinfo'>New row every "+ADDROW_TIMER_CEILING+" secs"+t+".<br><br></span>"):b="",w=$("<div id='startscreen' class='overlay' style='color: transparent'></div>"),w.append("<p>Clear the board.<br /><br />\nConnect 3 or more of the similar colors to POP them.<br /><br /> "+h+b+'<button class="btn btn-primary btn-large" id="startplaying" style="display:none">Start Playing</button><br />\n<span id="startmatch-container" style="font-size: 16px; font-weight: normal">or <a href="javascript:void(0)" id="startmatch">start a match</a></span>\n</p>'),o=$("<div id='gameover' class='overlay'></div>"),o.append("<p>Game Over <i class='fa fa-frown-o'></i></p>"),d=$("<div id='pause' class='overlay'></div>"),d.append("<p>Paused. o_O</p>"),g=$("<div id='victory' class='overlay'></div>"),g.append("<p>VICTORY! <i class='fa fa-smile-o'></p>"),s=$("<div id='notice-overlay'></div>"),_=$("<div id='shooter-control-overlay'></div>"),$("#popper-container").append(M),$("#popper-container").append(R),$("#popper-container").append(_),$("#popper-container").append(o),$("#popper-container").append(d),$("#popper-container").append(g),$("#popper-container").append(m),$("#popper-container").append(s),$("#popper-container").append(w),c=Math.floor(Math.random()*BUBBLE_OPTIONS.length),e=BUBBLE_OPTIONS[c],r="popper-"+e,$(".popper-shooter").addClass(r),_.mousemove(function(e){var r;isGameOver||isPaused||isWon||(r=(e.pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,r=Math.max(-MAX_ANGLE,r),r=Math.min(MAX_ANGLE,r),$(".popper-shooter").data("rotatedeg",r),$(".popper-shooter").css("transform","rotate("+r+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*r)/10))}),_.bind("touchmove",function(e){var r;isGameOver||isPaused||isWon||(e.preventDefault(),r=(e.originalEvent.touches[0].pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,r=Math.max(-MAX_ANGLE,r),r=Math.min(MAX_ANGLE,r),$(".popper-shooter").data("rotatedeg",r),$(".popper-shooter").css("transform","rotate("+r+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*r)/10))}),_.click(function(){var t,o;if(!(shooting||isGameOver||isPaused||isWon)){for(o=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*o)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",e).shoot(o),0!==ROW_TURNS_CEILING&&(addRowCounter+=Math.floor(Math.random()*ROW_TURNS_RAND)+1,addRowCounter>=Math.max(ROW_TURNS_FLOOR,ROW_TURNS_CEILING-ROW_TURNS_MULTIPLIER*numRowAdded)&&(addRow(),numRowAdded++,addRowCounter=0)),t=0;t<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[t]),t++;c=Math.floor(Math.random()*BUBBLE_OPTIONS.length),e=BUBBLE_OPTIONS[c],r="popper-"+e,$(".popper-shooter").addClass(r)}}),_.bind("touchend",function(t){var o,a;if(!(shooting||isGameOver||isPaused||isWon)){for(t.preventDefault(),a=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*a)/10),$("#popper-container").createBubble().addClass(r).attr("data-color",e).shoot(a),0!==ROW_TURNS_CEILING&&(addRowCounter+=Math.floor(Math.random()*ROW_TURNS_RAND)+1,addRowCounter>ROW_TURNS_CEILING-ROW_TURNS_MULTIPLIER*numRowAdded&&(addRow(),numRowAdded++,addRowCounter=0)),o=0;o<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[o]),o++;return c=Math.floor(Math.random()*BUBBLE_OPTIONS.length),e=BUBBLE_OPTIONS[c],r="popper-"+e,$(".popper-shooter").addClass(r)}}),I=$("#popper-container").width(),a=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,E=Math.floor(I/(2*BUBBLE_RADIUS)-.5),NUM_PER_ROW>0&&(E=NUM_PER_ROW),v=1.5*Math.floor(a/(2*BUBBLE_RADIUS)-.5)-1,l=(I-(E+.5)*BUBBLE_RADIUS*2)/2,bubbleMatrixOne=[],bubbleMatrix=[],i=0;v>i;){for(bubbleMatrixOne[i]=[],bubbleMatrix[i]=[],n=0;E>n;)i%2===0?(f=n*BUBBLE_RADIUS*2+l,U=a):f=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+l,U=a-BUBBLE_RADIUS*i*1.7,bubbleMatrixOne[i][n]={x:f,y:U},bubbleMatrix[i][n]={x:f,y:U},n++;i++}for(currMatrix="one",bubbleMatrixTwo=[],i=0;v>i;){for(bubbleMatrixTwo[i]=[],n=0;E>n;)i%2===1?(f=n*BUBBLE_RADIUS*2+l,U=a):f=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+l,U=a-BUBBLE_RADIUS*i*1.7,bubbleMatrixTwo[i][n]={x:f,y:U},n++;i++}return 0===ADDROW_TIMER_CEILING?($("#timer-container").hide(),addRowCounterSecs=1):($("#timer-container").show(),$("#addrowmeter").css("width","100%"),$("#timer").text(ADDROW_TIMER_CEILING).show(),addRowCounterSecs=ADDROW_TIMER_CEILING,p=.1,window.addrow=setInterval(function(){return isPaused===!1?($("#timer").text(Math.max(0,Math.ceil(addRowCounterSecs))),$("#addrowmeter").css("width",(addRowCounterSecs-1*p)/ADDROW_TIMER_CEILING*100+"%"),0>addRowCounterSecs&&(addRow(),numRowAdded++,addRowCounterSecs=Math.max(ADDROW_TIMER_MIN,ADDROW_TIMER_CEILING*Math.pow(ADDROW_TIMER_MULTIPLIER,numRowAdded))),addRowCounterSecs-=1*p):void 0},1e3*p)),addRows(DEFAULT_ROWS),$("#pause-button").click(function(){return isPaused===!1?(pause(),$(this).text("Go")):(unpause(),$(this).text("Pause"))}),$("#startplaying").click(function(){return $("#startscreen").hide(),unpause(),$("#popper-container").css("cursor","none")}),$("#startmatch").click(function(){var e,r;return r=fb.child("matches").push(),fb.child("matches").child(r.name()).child("created_on").set(Firebase.ServerValue.TIMESTAMP),fb.child("matches").child(r.name()).child("player1").set(user.id),e=fb.child("players").child(user.id).push(),fb.child("players").child(user.id).child(e.name()).set({name:"Rando",points:0,boardchange:{add:"",addrow:"",pop:"",currmatrix:"one"},send:""}),$("#startscreen").find("span").append("<br />link to match: <input type='text' value='"+window.location.origin+"/?m="+r.name()+"' />")})}),noticeFlash=function(e){return $("#notice-overlay").html(e).show().fadeOut({duration:1500})},getSlope=function(e){var r,t,o;return r=90-Math.abs(e),t=r*Math.PI/180,o=Math.tan(t)},getPointAtT=function(e,r){var t,o,a,n,i,l,u;return i=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,a=getSlope(r),l=e/Math.pow(1+a*a,.5),u=l*a,0===r?(l=0,u=e):(t=Math.ceil((l+i/2)/i),o=2*Math.floor((l/i+.5)/2),t%2===1?l-=i*o:l=i-(l-i*o),0>r&&(l=-l)),l+=i/2,u-=BUBBLE_RADIUS,n={x:l,y:u}},getPointAtY=function(e,r){var t,o,a,n;return a=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,t=getSlope(r),n=e/t,o=n*Math.pow(1+t*t,.5),getPointAtT(o,r)},findClosestInMatrix=function(e,r){var t,o,a,n,i,l;for(a=5e3,i={x:"",y:""},n={row:"",num:""},t=0;t<bubbleMatrix.length;){for(o=0;o<bubbleMatrix[0].length;)l=Math.pow(Math.pow(bubbleMatrix[t][o].x-e,2)+Math.pow(bubbleMatrix[t][o].y-r,2),.5),a>l&&(i.x=bubbleMatrix[t][o].x,i.y=bubbleMatrix[t][o].y,n.row=t,n.num=o,a=l),o++;t++}return n},addRows=function(e){var r,t;for(r=0,t=[];e>r;)addRow(),t.push(r++);return t},addRow=function(e,r){var t,o,a,n,i,l,u,s,d,c,p;if(scoochAllDown(),void 0===e)for(e=[],p=bubbleMatrix[0],u=0,d=p.length;d>u;u++)a=p[u],l=Math.floor(Math.random()*BUBBLE_OPTIONS.length),e.push(BUBBLE_OPTIONS[l]);else if(e.length<bubbleMatrix[0].length)for(a=e.length;a<bubbleMatrix[0].length;)l=Math.floor(Math.random()*BUBBLE_OPTIONS.length),e.push(BUBBLE_OPTIONS[l]),a++;for(i=0,s=0,c=e.length;c>s;s++)t=e[s],o=$("#popper-container").createBubble(t).addClass("popper-"+t).text("0,"+i),n={row:0,num:i},o.putInMatrix(n,!1),o.hide().fadeIn({duration:200}),i++;return void 0!==r?noticeFlash(r):void 0},scoochAllDown=function(e){var r,t,o;for(r=0,t=!1,o=bubbleMatrix.length;o>0;)for(o--,e=bubbleMatrix[o].length;e>0;)e--,isMatrixLocEmpty({row:o,num:e})||(moveBubble({row:o,num:e},{row:o+1,num:e}),t===!1&&(t=!0,r=o+1));return toggleMatrixPosition(),r>MAX_ROW_NUM?gameOver():void 0},moveBubble=function(e,r){var t;return t=getDivFromLoc(e),t.attr("data-matrow",r.row).attr("data-matnum",r.num),t.css("bottom",bubbleMatrix[r.row][r.num].y),t.css("left",bubbleMatrix[r.row][r.num].x),t.text(r.row+","+r.num),bubbleMatrix[r.row][r.num].div=bubbleMatrix[e.row][e.num].div,bubbleMatrix[r.row][r.num].color=bubbleMatrix[e.row][e.num].color,bubbleMatrix[e.row][e.num].div=void 0,bubbleMatrix[e.row][e.num].color=void 0},toggleMatrixPosition=function(){var e,r,t,o;for("one"===currMatrix?(e=bubbleMatrixTwo,currMatrix="two"):(e=bubbleMatrixOne,currMatrix="one"),o=0;o<e.length;){for(t=0;t<e[o].length;)bubbleMatrix[o][t].x=e[o][t].x,bubbleMatrix[o][t].y=e[o][t].y,isMatrixLocEmpty({row:o,num:t})||(r=$(".point[data-matrow='"+o+"'][data-matnum='"+t+"']"),r.css("left",e[o][t].x+"px").css("bottom",e[o][t].y)),t++;o++}},checkCluster=function(e,r,t,o){var a,n,i,l,u;if(void 0===r&&(r=!0),void 0===t?t=0:t++,void 0===o&&(o=[]),o.push(stringifyLoc(e)),a=[e],1e3>t){for(n=lookAround(e),l=0,u=n.length;u>l;l++)i=n[l],-1===$.inArray(stringifyLoc(i),o)&&(o.push(stringifyLoc(i)),r?getColor(i)===getColor(e)&&(a=a.concat(checkCluster(i,r,t,o))):a=a.concat(checkCluster(i,r,t,o)));return a}},isMatrixLocEmpty=function(e){return e.row<0||e.row>bubbleMatrix.length-1||e.num<0||e.num>bubbleMatrix[0].length-1?!0:void 0===bubbleMatrix[e.row][e.num].div},stringifyLoc=function(e){return e.row+","+e.num},getColor=function(e,r){return void 0===e.row?bubbleMatrix[e][r].color:bubbleMatrix[e.row][e.num].color},lookAround=function(e){var r,t,o,a,n,i,l,u,s;for(t=$(this[0]),l=e.row,i=e.num,o=[],r="one"===currMatrix?l%2===0?-1:0:l%2===1?-1:0,o.push({row:l-1,num:i+r}),o.push({row:l-1,num:i+r+1}),o.push({row:l,num:i-1}),o.push({row:l,num:i+1}),o.push({row:l+1,num:i+r}),o.push({row:l+1,num:i+r+1}),a=[],u=0,s=o.length;s>u;u++)n=o[u],isMatrixLocEmpty(n)||a.push(n);return a},drop=function(e,r,t){var o,a,n,i,l,u,s,d,c,p,h;if(void 0!==e){if(e instanceof Array){if(0===e.length)return;e=e}else e=[e];for("drop"===r&&(c=_.min(e,function(e){return e.row}),s=c.row,d=bubbleMatrix[s][0].y-$("#popper-container").height()),a=0,p=0,h=e.length;h>p;p++)n=e[p],bubbleMatrix[n.row][n.num].color=void 0,bubbleMatrix[n.row][n.num].div=void 0,i=getDivFromLoc(n),"drop"===r?(u=d,l=Math.pow(n.row-s+1,1.1),o=-50*l,u+=o,a===e.length-1?i.animate({bottom:u+"px"},{duration:600,complete:function(){return void 0!==t&&t(),$(this).remove()}}):i.animate({bottom:u+"px"},{duration:600,complete:function(){return $(this).remove()}})):i.fadeOut(a===e.length-1?{duration:150,complete:function(){return void 0!==t&&setTimeout(function(){return t()},10),$(this).remove()}}:{duration:150,complete:function(){return $(this).remove()}}),a++}},getDivFromLoc=function(e){var r;return r=$(".point[data-matrow="+e.row+"][data-matnum="+e.num+"]")},gameOver=function(){return $("#gameover").show(),isGameOver=!0,clearInterval(window.addrow),shooting=!1,$("#pause-button").addClass("disabled")},pause=function(){return $("#pause").show(),isPaused=!0},unpause=function(){return $("#pause").hide(),isPaused=!1},win=function(){return $("#victory").show(),clearInterval(window.addrow),isWon=!0,shooting=!1,$("#pause-button").addClass("disabled")},checkIfWon=function(){var e,r,t,o;for(e=!0,o=0;o<bubbleMatrix.length;){for(t=0;t<bubbleMatrix[o].length;){if(r={row:o,num:t},!isMatrixLocEmpty(r)){e=!1;break}t++}o++}return e},addToScore=function(e){var r,t;return t=parseInt($("#score").text()),r=t+e,10>r?$("#score").text("0000"+r):r>=10?$("#score").text("000"+r):r>=100?$("#score").text("00"+r):r>=1e3?$("#score").text("0"+r):r>=1e4?$("#score").text(r):($("#score").text(r),$("#score-container").css("font-size","28px"))},addToScrewQueue=function(e){var r,t,o,a,n,i,l,u;for(u=[],a=0,i=e.length;i>a;a++){if(o=e[a],t=bubbleMatrix[o.row][o.num].color,screwQueue.push(t),$(".screwqueue-"+(screwQueue.length-1)).addClass("popper-"+t),10===screwQueue.length)for(fb.child("players").child(user.id).child("boardchange").child("addrow").push(screwQueue),screwQueue=[],n=0,l=BUBBLE_OPTIONS.length;l>n;n++)r=BUBBLE_OPTIONS[n],$(".screwqueue-ball").removeClass("popper-"+r);u.push($("#screwqueue-length").text(screwQueue.length))}return u},jQuery.fn.createBubble=function(e){var r;return r=$("<div class='point'></div>"),r.css("width",2*BUBBLE_RADIUS+"px").css("height",2*BUBBLE_RADIUS+"px").css("border-width",BUBBLE_BORDER+"px"),void 0!==e&&r.attr("data-color",e),$(this[0]).append(r),r},jQuery.fn.putInMatrix=function(e,r){var t,o,a,n;void 0===r&&(r=!0),a=$(this[0]),bubbleMatrix[e.row][e.num].div=a,bubbleMatrix[e.row][e.num].color=a.attr("data-color"),t=bubbleMatrix[e.row][e.num],a.drawAt(t.x,t.y),a.attr("data-matrow",e.row),a.attr("data-matnum",e.num),a.text(e.row+", "+e.num),r===!0&&(o=0,n=checkCluster(e,!0),n.length>=3?(addToScore(n.length),drop(n,"fade",function(){var e,r,t,o,a,n,i,l,u,s,d,c,p,h,b,m;for(c=[],a=0,m=bubbleMatrix[0],h=0,b=m.length;b>h;h++)e=m[h],c.push(a),a++;for(p=[],a=0;a<c.length&&1e3>a;)i={row:0,num:a},isMatrixLocEmpty(i)?a++:(p=p.concat(checkCluster(i,!1)),o=_.max(_.where(p,{row:0}),function(e){return e.num}),a=o.num+1);for(l=[],d=0;d<bubbleMatrix.length;){for(u=0;u<bubbleMatrix[d].length;)n={row:d,num:u},isMatrixLocEmpty(n)||0===_.where(p,n).length&&l.push(n),u++;d++}return l.length>0&&(t=Math.round(l.length*DROP_TIME_MULTIPLER),s=addRowCounterSecs+t,s=Math.min(s,ADDROW_TIMER_CEILING),addRowCounterSecs=s,$("#addrowmeter").css("width",addRowCounterSecs/ADDROW_TIMER_CEILING*100+"%")),l.length>0?(r=Math.ceil(Math.pow(l.length,DROP_MULTIPLER)),r>1?noticeFlash("<small>Dropped "+l.length+"!</small><br />"+r+" bonus points!!"):1===r&&noticeFlash("<small>Dropped 1</small><br />"+r+" bonus point!")):r=0,addToScore(l.length+r),isMultiPlayer&&addToScrewQueue(l),drop(l,"drop",function(){return checkIfWon()===!0?win():void 0}),checkIfWon()===!0?win():void 0})):e.row>MAX_ROW_NUM&&(gameOver(),a=$(".point").last(),a.css("background-color","#DDD").css("border-color","#BBB"),a.putInMatrix(prevMatrixLoc))),shooting=!1},jQuery.fn.drawAt=function(e,r){$(this[0]).show().css("bottom",r+"px").css("left",+e+"px")},jQuery.fn.shoot=function(e){var r,t,o,a,n;return t=$(this[0]),clearInterval(window.shootInterval),a={row:"",num:""},o=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,n=0,r=0,window.shootInterval=setInterval(function(){var i,l,u;shooting=!0,u=getPointAtT(n,e),u.y<=o?(l=findClosestInMatrix(u.x,u.y),isMatrixLocEmpty(l)?(r%2===0&&t.drawAt(u.x,u.y),a=l,n+=SPEED):(clearInterval(window.shootInterval),t.putInMatrix(a))):(clearInterval(window.shootInterval),i=getPointAtY(o+BUBBLE_RADIUS,e),l=findClosestInMatrix(i.x,i.y),t.putInMatrix(isMatrixLocEmpty(l)?l:a))},5),t};