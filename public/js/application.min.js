var BUBBLE_BORDER,BUBBLE_OPTIONS,BUBBLE_RADIUS,CONTAINER_BORDER,DEFAULT_ROWS,DROP_MULTIPLER,DROP_TIME_MULTIPLER,MAX_ANGLE,MAX_ROW_NUM,ROW_COUNTER_CEILING,ROW_COUNTER_INTERVAL,SPEED,addRow,addRowCounter,addRowCounterSecs,addRows,bubbleMatrix,bubbleMatrixOne,bubbleMatrixTwo,checkCluster,checkIfWon,currMatrix,drop,findClosestInMatrix,gameOver,getColor,getDivFromLoc,getPointAtT,getPointAtY,getSlope,isGameOver,isMatrixLocEmpty,isPaused,isWon,lookAround,moveBubble,noticeFlash,pause,scoochAllDown,shooting,stringifyLoc,toggleMatrixPosition,unpause,win;BUBBLE_BORDER=5,BUBBLE_RADIUS=25,CONTAINER_BORDER=5,SPEED=20,MAX_ANGLE=75,BUBBLE_OPTIONS=["red","green","yellow","blue"],ROW_COUNTER_CEILING=1e4,ROW_COUNTER_INTERVAL=15,MAX_ROW_NUM=10,DROP_MULTIPLER=1.2,DROP_TIME_MULTIPLER=.5,DEFAULT_ROWS=3,addRowCounter=0,shooting=!1,currMatrix="",isGameOver=!1,isPaused=!0,isWon=!1,bubbleMatrix=[],bubbleMatrixOne=[],bubbleMatrixTwo=[],addRowCounterSecs=ROW_COUNTER_INTERVAL,$(document).ready(function(){var t,o,r,e,n,a,i,u,s,d,l,p,c,b,h,B,M,w,m,f,x,R;for($("#addrowmeter").css("width","100%"),$("#timer").text(ROW_COUNTER_INTERVAL),p=$("<div class='popper-shooter'></div>"),b=$("<div id='shooter-control'></div>"),c=$("<div id='shooter-base'></div>"),B=$("<div id='startscreen' class='overlay'></div>"),B.append('<p>Clear the board.<br /><br />\nConnect 3 or more of the similar colors to POP them.<br /><br />\n..eh.. you\'ll figure out the rest.<br /><br />\n<button class="btn btn-primary btn-large" id="startplaying">Start Playing</button></p>'),r=$("<div id='gameover' class='overlay'></div>"),r.append("<p>Game Over <i class='fa fa-frown-o'></i></p>"),s=$("<div id='pause' class='overlay'></div>"),s.append("<p>Paused. o_O</p>"),w=$("<div id='victory' class='overlay'></div>"),w.append("<p>VICTORY! <i class='fa fa-smile-o'></p>"),u=$("<div id='notice-overlay'></div>"),h=$("<div id='shooter-control-overlay'></div>"),$("#popper-container").append(b),$("#popper-container").append(c),$("#popper-container").append(h),$("#popper-container").append(r),$("#popper-container").append(s),$("#popper-container").append(w),$("#popper-container").append(p),$("#popper-container").append(u),$("#popper-container").append(B),d=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t=BUBBLE_OPTIONS[d],o="popper-"+t,$(".popper-shooter").addClass(o),h.mousemove(function(t){var o;isGameOver||isPaused||isWon||(o=(t.pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,o=Math.max(-MAX_ANGLE,o),o=Math.min(MAX_ANGLE,o),$(".popper-shooter").data("rotatedeg",o),$(".popper-shooter").css("transform","rotate("+o+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*o)/10))}),h.bind("touchmove",function(t){var o;isGameOver||isPaused||isWon||(t.preventDefault(),o=(t.originalEvent.touches[0].pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,o=Math.max(-MAX_ANGLE,o),o=Math.min(MAX_ANGLE,o),$(".popper-shooter").data("rotatedeg",o),$(".popper-shooter").css("transform","rotate("+o+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*o)/10))}),h.click(function(){var r,e;if(!(shooting||isGameOver||isPaused||isWon)){for(e=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*e)/10),$("#popper-container").createBubble().addClass(o).attr("data-color",t).shoot(e),addRowCounter+=Math.floor(2*Math.random())+1,addRowCounter>ROW_COUNTER_CEILING&&(addRow(),addRowCounter=0),r=0;r<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[r]),r++;d=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t=BUBBLE_OPTIONS[d],o="popper-"+t,$(".popper-shooter").addClass(o)}}),h.bind("touchend",function(r){var e,n;if(!(shooting||isGameOver||isPaused||isWon)){for(r.preventDefault(),n=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*n)/10),$("#popper-container").createBubble().addClass(o).attr("data-color",t).shoot(n),addRowCounter+=Math.floor(2*Math.random())+1,addRowCounter>ROW_COUNTER_CEILING&&(addRow(),addRowCounter=0),e=0;e<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[e]),e++;return d=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t=BUBBLE_OPTIONS[d],o="popper-"+t,$(".popper-shooter").addClass(o)}}),M=$("#popper-container").width(),e=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,f=Math.floor(M/(2*BUBBLE_RADIUS)-.5),R=1.5*Math.floor(e/(2*BUBBLE_RADIUS)-.5)-1,i=(M-(f+.5)*BUBBLE_RADIUS*2)/2,bubbleMatrixOne=[],bubbleMatrix=[],a=0;R>a;){for(bubbleMatrixOne[a]=[],bubbleMatrix[a]=[],n=0;f>n;)a%2===0?(m=n*BUBBLE_RADIUS*2+i,x=e):m=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+i,x=e-BUBBLE_RADIUS*a*1.7,bubbleMatrixOne[a][n]={x:m,y:x},bubbleMatrix[a][n]={x:m,y:x},n++;a++}for(currMatrix="one",bubbleMatrixTwo=[],a=0;R>a;){for(bubbleMatrixTwo[a]=[],n=0;f>n;)a%2===1?(m=n*BUBBLE_RADIUS*2+i,x=e):m=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+i,x=e-BUBBLE_RADIUS*a*1.7,bubbleMatrixTwo[a][n]={x:m,y:x},n++;a++}return addRows(DEFAULT_ROWS),addRowCounterSecs=ROW_COUNTER_INTERVAL,l=.1,window.addrow=setInterval(function(){return isPaused===!1&&($("#timer").text(Math.ceil(addRowCounterSecs-1*l)),$("#addrowmeter").css("width",(addRowCounterSecs-1*l)/ROW_COUNTER_INTERVAL*100+"%"),addRowCounterSecs-=1*l,1>addRowCounterSecs)?(addRow(),addRowCounterSecs=ROW_COUNTER_INTERVAL):void 0},1e3*l),$("#pause-button").click(function(){return isPaused===!1?(pause(),$(this).text("Go")):(unpause(),$(this).text("Pause"))}),$("#startplaying").click(function(){return $("#startscreen").hide(),unpause(),$("#popper-container").css("cursor","none")})}),noticeFlash=function(t){return $("#notice-overlay").html(t).show().fadeOut({duration:1500})},getSlope=function(t){var o,r,e;return o=90-Math.abs(t),r=o*Math.PI/180,e=Math.tan(r)},getPointAtT=function(t,o){var r,e,n,a,i,u,s;return i=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,n=getSlope(o),u=t/Math.pow(1+n*n,.5),s=u*n,0===o?(u=0,s=t):(r=Math.ceil((u+i/2)/i),e=2*Math.floor((u/i+.5)/2),r%2===1?u-=i*e:u=i-(u-i*e),0>o&&(u=-u)),u+=i/2,s-=BUBBLE_RADIUS,a={x:u,y:s}},getPointAtY=function(t,o){var r,e,n,a;return n=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,r=getSlope(o),a=t/r,e=a*Math.pow(1+r*r,.5),getPointAtT(e,o)},findClosestInMatrix=function(t,o){var r,e,n,a,i,u;for(n=5e3,i={x:"",y:""},a={row:"",num:""},r=0;r<bubbleMatrix.length;){for(e=0;e<bubbleMatrix[0].length;)u=Math.pow(Math.pow(bubbleMatrix[r][e].x-t,2)+Math.pow(bubbleMatrix[r][e].y-o,2),.5),n>u&&(i.x=bubbleMatrix[r][e].x,i.y=bubbleMatrix[r][e].y,a.row=r,a.num=e,n=u),e++;r++}return a},addRows=function(t){var o,r;for(o=0,r=[];t>o;)addRow(),r.push(o++);return r},addRow=function(t){var o,r,e,n,a,i,u,s,d,l,p,c;if(scoochAllDown(),void 0===t)for(t=[],p=bubbleMatrix[0],u=0,d=p.length;d>u;u++)e=p[u],i=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t.push(BUBBLE_OPTIONS[i]);else if(t.length<bubbleMatrix[0].length)for(e=t.length;e<bubbleMatrix[0].length;)i=Math.floor(Math.random()*BUBBLE_OPTIONS.length),t.push(BUBBLE_OPTIONS[i]),e++;for(a=0,c=[],s=0,l=t.length;l>s;s++)o=t[s],r=$("#popper-container").createBubble(o).addClass("popper-"+o).text("0,"+a),n={row:0,num:a},r.putInMatrix(n,!1),r.hide().fadeIn({duration:200}),c.push(a++);return c},scoochAllDown=function(t){var o,r,e;for(o=0,r=!1,e=bubbleMatrix.length;e>0;)for(e--,t=bubbleMatrix[e].length;t>0;)t--,isMatrixLocEmpty({row:e,num:t})||(moveBubble({row:e,num:t},{row:e+1,num:t}),r===!1&&(r=!0,o=e+1));return toggleMatrixPosition(),o>MAX_ROW_NUM?gameOver():void 0},moveBubble=function(t,o){var r;return r=getDivFromLoc(t),r.attr("data-matrow",o.row).attr("data-matnum",o.num),r.css("bottom",bubbleMatrix[o.row][o.num].y),r.css("left",bubbleMatrix[o.row][o.num].x),r.text(o.row+","+o.num),bubbleMatrix[o.row][o.num].div=bubbleMatrix[t.row][t.num].div,bubbleMatrix[o.row][o.num].color=bubbleMatrix[t.row][t.num].color,bubbleMatrix[t.row][t.num].div=void 0,bubbleMatrix[t.row][t.num].color=void 0},toggleMatrixPosition=function(){var t,o,r,e;for("one"===currMatrix?(t=bubbleMatrixTwo,currMatrix="two"):(t=bubbleMatrixOne,currMatrix="one"),e=0;e<t.length;){for(r=0;r<t[e].length;)bubbleMatrix[e][r].x=t[e][r].x,bubbleMatrix[e][r].y=t[e][r].y,isMatrixLocEmpty({row:e,num:r})||(o=$(".point[data-matrow='"+e+"'][data-matnum='"+r+"']"),o.css("left",t[e][r].x+"px").css("bottom",t[e][r].y)),r++;e++}},checkCluster=function(t,o,r,e){var n,a,i,u,s;if(void 0===o&&(o=!0),void 0===r?r=0:r++,void 0===e&&(e=[]),e.push(stringifyLoc(t)),n=[t],1e3>r){for(a=lookAround(t),u=0,s=a.length;s>u;u++)i=a[u],-1===$.inArray(stringifyLoc(i),e)&&(e.push(stringifyLoc(i)),o?getColor(i)===getColor(t)&&(n=n.concat(checkCluster(i,o,r,e))):n=n.concat(checkCluster(i,o,r,e)));return n}},isMatrixLocEmpty=function(t){return t.row<0||t.row>bubbleMatrix.length-1||t.num<0||t.num>bubbleMatrix[0].length-1?!0:void 0===bubbleMatrix[t.row][t.num].div},stringifyLoc=function(t){return t.row+","+t.num},getColor=function(t,o){return void 0===t.row?bubbleMatrix[t][o].color:bubbleMatrix[t.row][t.num].color},lookAround=function(t){var o,r,e,n,a,i,u,s,d;for(r=$(this[0]),u=t.row,i=t.num,e=[],o="one"===currMatrix?u%2===0?-1:0:u%2===1?-1:0,e.push({row:u-1,num:i+o}),e.push({row:u-1,num:i+o+1}),e.push({row:u,num:i-1}),e.push({row:u,num:i+1}),e.push({row:u+1,num:i+o}),e.push({row:u+1,num:i+o+1}),n=[],s=0,d=e.length;d>s;s++)a=e[s],isMatrixLocEmpty(a)||n.push(a);return n},drop=function(t,o,r){var e,n,a,i,u,s,d,l,p,c,b;if(void 0!==t){if(t instanceof Array){if(0===t.length)return;t=t}else t=[t];for("drop"===o&&(p=_.min(t,function(t){return t.row}),d=p.row,l=bubbleMatrix[d][0].y-$("#popper-container").height()),n=0,c=0,b=t.length;b>c;c++)a=t[c],bubbleMatrix[a.row][a.num].color=void 0,bubbleMatrix[a.row][a.num].div=void 0,i=getDivFromLoc(a),"drop"===o?(s=l,u=Math.pow(a.row-d+1,1.1),e=-50*u,s+=e,n===t.length-1?i.animate({bottom:s+"px"},{duration:600,complete:function(){return void 0!==r?r():void 0}}):i.animate({bottom:s+"px"},{duration:600})):i.fadeOut(n===t.length-1?{duration:150,complete:function(){return void 0!==r?setTimeout(function(){return r()},10):void 0}}:{duration:150}),n++}},getDivFromLoc=function(t){var o;return o=$(".point[data-matrow="+t.row+"][data-matnum="+t.num+"]")},gameOver=function(){return $("#gameover").show(),isGameOver=!0,clearInterval(window.addrow),shooting=!1,$("#pause-button").addClass("disabled")},pause=function(){return $("#pause").show(),isPaused=!0},unpause=function(){return $("#pause").hide(),isPaused=!1},win=function(){return $("#victory").show(),clearInterval(window.addrow),isWon=!0,shooting=!1,$("#pause-button").addClass("disabled")},checkIfWon=function(){var t,o,r,e;for(t=!0,e=0;e<bubbleMatrix.length;){for(r=0;r<bubbleMatrix[e].length;){if(o={row:e,num:r},!isMatrixLocEmpty(o)){t=!1;break}r++}e++}return t},jQuery.fn.createBubble=function(t){var o;return o=$("<div class='point'></div>"),o.css("width",2*BUBBLE_RADIUS+"px").css("height",2*BUBBLE_RADIUS+"px").css("border-width",BUBBLE_BORDER+"px"),void 0!==t&&o.attr("data-color",t),$(this[0]).append(o),o},jQuery.fn.putInMatrix=function(t,o){var r,e,n,a,i;void 0===o&&(o=!0),n=$(this[0]),bubbleMatrix[t.row][t.num].div=n,bubbleMatrix[t.row][t.num].color=n.attr("data-color"),r=bubbleMatrix[t.row][t.num],n.drawAt(r.x,r.y),n.attr("data-matrow",t.row),n.attr("data-matnum",t.num),n.text(t.row+", "+t.num),o===!0&&(e=0,i=checkCluster(t,!0),i.length>=3?(a=parseInt($("#score").text()),$("#score").text(a+i.length),a+i.length>999?$("#score-container").css("font-size","32px"):a+i.length>9999&&$("#score-container").css("font-size","28px"),drop(i,"fade",function(){var t,o,r,e,n,i,u,s,d,l,p,c,b,h,B,M;for(c=[],n=0,M=bubbleMatrix[0],h=0,B=M.length;B>h;h++)t=M[h],c.push(n),n++;for(b=[],n=0;n<c.length&&1e3>n;)u={row:0,num:n},isMatrixLocEmpty(u)?n++:(b=b.concat(checkCluster(u,!1)),e=_.max(_.where(b,{row:0}),function(t){return t.num}),n=e.num+1);for(s=[],p=0;p<bubbleMatrix.length;){for(d=0;d<bubbleMatrix[p].length;)i={row:p,num:d},isMatrixLocEmpty(i)||0===_.where(b,i).length&&s.push(i),d++;p++}return s.length>1&&(r=Math.round(s.length*DROP_TIME_MULTIPLER),l=addRowCounterSecs+r,l=Math.min(l,ROW_COUNTER_INTERVAL),addRowCounterSecs=l,$("#addrowmeter").css("width",addRowCounterSecs/ROW_COUNTER_INTERVAL*100+"%")),s.length>0?(o=Math.ceil(Math.pow(s.length,DROP_MULTIPLER)),o>1?noticeFlash("<small>Dropped "+s.length+"!</small><br />"+o+" bonus points!!"):1===o&&noticeFlash("<small>Dropped 1</small><br />"+o+" bonus point!")):o=0,a=parseInt($("#score").text()),$("#score").text(a+s.length+o),a+s.length+o>999?$("#score-container").css("font-size","32px"):a+s.length+o>9999&&$("#score-container").css("font-size","28px"),drop(s,"drop",function(){return checkIfWon()===!0?win():void 0}),checkIfWon()===!0?win():void 0})):t.row>MAX_ROW_NUM&&(gameOver(),n=$(".point").last(),n.css("background-color","#DDD").css("border-color","#BBB"),n.putInMatrix(prevMatrixLoc))),shooting=!1},jQuery.fn.drawAt=function(t,o){$(this[0]).show().css("bottom",o+"px").css("left",+t+"px")},jQuery.fn.shoot=function(t){var o,r,e,n,a;return r=$(this[0]),clearInterval(window.shootInterval),n={row:"",num:""},e=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,a=0,o=0,window.shootInterval=setInterval(function(){var i,u,s;shooting=!0,s=getPointAtT(a,t),s.y<=e?(u=findClosestInMatrix(s.x,s.y),isMatrixLocEmpty(u)?(o%2===0&&r.drawAt(s.x,s.y),n=u,a+=SPEED):(clearInterval(window.shootInterval),r.putInMatrix(n))):(clearInterval(window.shootInterval),i=getPointAtY(e+BUBBLE_RADIUS,t),u=findClosestInMatrix(i.x,i.y),r.putInMatrix(isMatrixLocEmpty(u)?u:n))},5),r};