var BUBBLE_BORDER,BUBBLE_OPTIONS,BUBBLE_RADIUS,CONTAINER_BORDER,MAX_ANGLE,SPEED,addRow,addRowCeiling,addRowCounter,addRows,bubbleMatrix,bubbleMatrixOne,bubbleMatrixTwo,checkCluster,currMatrix,drop,findClosestInMatrix,gameover,getColor,getDivFromLoc,getPointAtT,getPointAtY,getSlope,isMatrixLocEmpty,lookAround,moveBubble,scoochAllDown,shooting,stringifyLoc,toggleMatrixPosition;BUBBLE_BORDER=5,BUBBLE_RADIUS=25,CONTAINER_BORDER=5,SPEED=20,MAX_ANGLE=75,bubbleMatrix=[],bubbleMatrixOne=[],bubbleMatrixTwo=[],currMatrix="",shooting=!1,gameover=!1,BUBBLE_OPTIONS=["red","green","yellow","blue"],addRowCounter=0,addRowCeiling=10,$(document).ready(function(){var o,t,r,e,n,a,i,u,l,b,d,p,s,h,c,B,M;for(l=$("<div class='popper-shooter'></div>"),d=$("<div id='shooter-control'></div>"),b=$("<div id='shooter-base'></div>"),p=$("<div id='shooter-control-overlay'></div>"),r=$("<div id='gameover'></div>"),r.append("<div style='color: #300; text-align: center; font-size: 60px; margin-top: 200px'><strong>Game Over <i class='fa fa-frown-o'></i></strong></div>"),$("#popper-container").append(d),$("#popper-container").append(b),$("#popper-container").append(p),$("#popper-container").append(r),$("#popper-container").append(l),u=Math.floor(Math.random()*BUBBLE_OPTIONS.length),o=BUBBLE_OPTIONS[u],t="popper-"+o,$(".popper-shooter").addClass(t),p.mousemove(function(o){var t;gameover||(t=(o.pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,t=Math.max(-MAX_ANGLE,t),t=Math.min(MAX_ANGLE,t),$(".popper-shooter").data("rotatedeg",t),$(".popper-shooter").css("transform","rotate("+t+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*t)/10))}),p.bind("touchmove",function(o){var t;gameover||(o.preventDefault(),t=(o.originalEvent.touches[0].pageX-$(this).offset().left)/$(this).outerWidth()*160-MAX_ANGLE,t=Math.max(-MAX_ANGLE,t),t=Math.min(MAX_ANGLE,t),$(".popper-shooter").data("rotatedeg",t),$(".popper-shooter").css("transform","rotate("+t+"deg)"),$("#shooter-rotate-deg").text("Shooter at "+Math.round(10*t)/10))}),p.click(function(){var r,e;if(!shooting&&!gameover){for(e=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*e)/10),$("#popper-container").createBubble().addClass(t).attr("data-color",o).shoot(e),addRowCounter+=Math.floor(2*Math.random())+1,addRowCounter>addRowCeiling&&(addRow(),addRowCounter=0),r=0;r<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[r]),r++;u=Math.floor(Math.random()*BUBBLE_OPTIONS.length),o=BUBBLE_OPTIONS[u],t="popper-"+o,$(".popper-shooter").addClass(t)}}),p.bind("touchend",function(r){var e,n;if(!shooting&&!gameover){for(r.preventDefault(),n=Number($(".popper-shooter").data("rotatedeg")),$("#shoot-at-deg").text("Shoot at: "+Math.round(10*n)/10),$("#popper-container").createBubble().addClass(t).attr("data-color",o).shoot(n),addRowCounter+=Math.floor(2*Math.random())+1,addRowCounter>addRowCeiling&&(addRow(),addRowCounter=0),e=0;e<BUBBLE_OPTIONS.length;)$(".popper-shooter").removeClass("popper-"+BUBBLE_OPTIONS[e]),e++;u=Math.floor(Math.random()*BUBBLE_OPTIONS.length),o=BUBBLE_OPTIONS[u],t="popper-"+o,$(".popper-shooter").addClass(t)}}),s=$("#popper-container").width(),e=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,c=Math.floor(s/(2*BUBBLE_RADIUS)-.5),M=1.5*Math.floor(e/(2*BUBBLE_RADIUS)-.5)-1,i=(s-(c+.5)*BUBBLE_RADIUS*2)/2,bubbleMatrixOne=[],bubbleMatrix=[],a=0;M>a;){for(bubbleMatrixOne[a]=[],bubbleMatrix[a]=[],n=0;c>n;)a%2===0?(h=n*BUBBLE_RADIUS*2+i,B=e):h=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+i,B=e-BUBBLE_RADIUS*a*1.7,bubbleMatrixOne[a][n]={x:h,y:B},bubbleMatrix[a][n]={x:h,y:B},n++;a++}for(currMatrix="one",bubbleMatrixTwo=[],a=0;M>a;){for(bubbleMatrixTwo[a]=[],n=0;c>n;)a%2===1?(h=n*BUBBLE_RADIUS*2+i,B=e):h=n*BUBBLE_RADIUS*2+BUBBLE_RADIUS+i,B=e-BUBBLE_RADIUS*a*1.7,bubbleMatrixTwo[a][n]={x:h,y:B},n++;a++}addRows(3)}),getSlope=function(o){var t,r,e;return t=90-Math.abs(o),r=t*Math.PI/180,e=Math.tan(r)},getPointAtT=function(o,t){var r,e,n,a,i,u,l;return i=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,n=getSlope(t),u=o/Math.pow(1+n*n,.5),l=u*n,0===t?(u=0,l=o):(r=Math.ceil((u+i/2)/i),e=2*Math.floor((u/i+.5)/2),r%2===1?u-=i*e:u=i-(u-i*e),0>t&&(u=-u)),u+=i/2,l-=BUBBLE_RADIUS,a={x:u,y:l}},getPointAtY=function(o,t){var r,e,n,a;return n=$("#popper-container").outerWidth()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,r=getSlope(t),a=o/r,e=a*Math.pow(1+r*r,.5),getPointAtT(e,t)},findClosestInMatrix=function(o,t){var r,e,n,a,i,u;for(n=5e3,i={x:"",y:""},a={row:"",num:""},r=0;r<bubbleMatrix.length;){for(e=0;e<bubbleMatrix[0].length;)u=Math.pow(Math.pow(bubbleMatrix[r][e].x-o,2)+Math.pow(bubbleMatrix[r][e].y-t,2),.5),n>u&&(i.x=bubbleMatrix[r][e].x,i.y=bubbleMatrix[r][e].y,a.row=r,a.num=e,n=u),e++;r++}return a},addRows=function(o){var t,r;for(t=0,r=[];o>t;)addRow(),r.push(t++);return r},addRow=function(o){var t,r,e,n,a,i,u,l,b,d,p,s;if(scoochAllDown(),void 0===o)for(o=[],p=bubbleMatrix[0],u=0,b=p.length;b>u;u++)e=p[u],i=Math.floor(Math.random()*BUBBLE_OPTIONS.length),o.push(BUBBLE_OPTIONS[i]);else if(o.length<bubbleMatrix[0].length)for(e=o.length;e<bubbleMatrix[0].length;)i=Math.floor(Math.random()*BUBBLE_OPTIONS.length),o.push(BUBBLE_OPTIONS[i]),e++;for(a=0,s=[],l=0,d=o.length;d>l;l++)t=o[l],r=$("#popper-container").createBubble(t).addClass("popper-"+t).text("0,"+a),n={row:0,num:a},r.putInMatrix(n,!1),r.hide().fadeIn({duration:200}),s.push(a++);return s},scoochAllDown=function(o){var t;for(t=bubbleMatrix.length;t>0;)for(t--,o=bubbleMatrix[t].length;o>0;)o--,isMatrixLocEmpty({row:t,num:o})||moveBubble({row:t,num:o},{row:t+1,num:o});return toggleMatrixPosition()},moveBubble=function(o,t){var r;return r=getDivFromLoc(o),r.attr("data-matrow",t.row).attr("data-matnum",t.num),r.css("bottom",bubbleMatrix[t.row][t.num].y),r.css("left",bubbleMatrix[t.row][t.num].x),r.text(t.row+","+t.num),bubbleMatrix[t.row][t.num].div=bubbleMatrix[o.row][o.num].div,bubbleMatrix[t.row][t.num].color=bubbleMatrix[o.row][o.num].color,bubbleMatrix[o.row][o.num].div=void 0,bubbleMatrix[o.row][o.num].color=void 0},toggleMatrixPosition=function(){var o,t,r,e;for("one"===currMatrix?(o=bubbleMatrixTwo,currMatrix="two"):(o=bubbleMatrixOne,currMatrix="one"),e=0;e<o.length;){for(r=0;r<o[e].length;)bubbleMatrix[e][r].x=o[e][r].x,bubbleMatrix[e][r].y=o[e][r].y,isMatrixLocEmpty({row:e,num:r})||(t=$(".point[data-matrow='"+e+"'][data-matnum='"+r+"']"),t.css("left",o[e][r].x+"px").css("bottom",o[e][r].y)),r++;e++}},checkCluster=function(o,t,r,e){var n,a,i,u,l;if(void 0===t&&(t=!0),void 0===r?r=0:r++,void 0===e&&(e=[]),e.push(stringifyLoc(o)),n=[o],1e3>r){for(a=lookAround(o),u=0,l=a.length;l>u;u++)i=a[u],-1===$.inArray(stringifyLoc(i),e)&&(e.push(stringifyLoc(i)),t?getColor(i)===getColor(o)&&(n=n.concat(checkCluster(i,t,r,e))):n=n.concat(checkCluster(i,t,r,e)));return n}return console.log("too many recursions")},isMatrixLocEmpty=function(o){return o.row<0||o.row>bubbleMatrix.length-1||o.num<0||o.num>bubbleMatrix[0].length-1?!0:void 0===bubbleMatrix[o.row][o.num].div},stringifyLoc=function(o){return o.row+","+o.num},getColor=function(o,t){return void 0===o.row?bubbleMatrix[o][t].color:bubbleMatrix[o.row][o.num].color},lookAround=function(o){var t,r,e,n,a,i,u,l,b;for(r=$(this[0]),u=o.row,i=o.num,e=[],t="one"===currMatrix?u%2===0?-1:0:u%2===1?-1:0,e.push({row:u-1,num:i+t}),e.push({row:u-1,num:i+t+1}),e.push({row:u,num:i-1}),e.push({row:u,num:i+1}),e.push({row:u+1,num:i+t}),e.push({row:u+1,num:i+t+1}),n=[],l=0,b=e.length;b>l;l++)a=e[l],isMatrixLocEmpty(a)||n.push(a);return n},drop=function(o,t,r){var e,n,a,i,u,l,b,d;for(o=o instanceof Array?o:[o],u=_.min(o,function(o){return o.row}),l=u.row,b=0,d=o.length;d>b;b++)n=o[b],bubbleMatrix[n.row][n.num].color=void 0,bubbleMatrix[n.row][n.num].div=void 0,a=getDivFromLoc(n),e=parseInt(a.css("bottom")),i=(e-$("#popper-container").height())*(3*(n.row-u.row+1)+1),"drop"===t?a.animate({bottom:i+"px"},{duration:600,complete:function(){return void 0!==r?r():void 0}}):a.fadeOut({duration:150,complete:function(){return void 0!==r?setTimeout(function(){return r()},10):void 0}})},getDivFromLoc=function(o){var t;return t=$(".point[data-matrow="+o.row+"][data-matnum="+o.num+"]")},jQuery.fn.createBubble=function(o){var t;return t=$("<div class='point'></div>"),t.css("width",2*BUBBLE_RADIUS+"px").css("height",2*BUBBLE_RADIUS+"px").css("border-width",BUBBLE_BORDER+"px"),void 0!==o&&t.attr("data-color",o),$(this[0]).append(t),t},jQuery.fn.putInMatrix=function(o,t){var r,e,n,a,i;void 0===t&&(t=!0),n=$(this[0]),bubbleMatrix[o.row][o.num].div=n,bubbleMatrix[o.row][o.num].color=n.attr("data-color"),r=bubbleMatrix[o.row][o.num],n.drawAt(r.x,r.y),n.attr("data-matrow",o.row),n.attr("data-matnum",o.num),n.text(o.row+", "+o.num),t===!0&&(e=0,i=checkCluster(o,!0),i.length>=3?(a=parseInt($("#score").text()),drop(i,"fade",function(){var o,t,r,n,i,u,l,b,d,p,s,h,c;for(d=[],r=0,c=bubbleMatrix[0],s=0,h=c.length;h>s;s++)o=c[s],d.push(r),r++;for(p=[],r=0;r<d.length&&1e3>r;)i={row:0,num:r},isMatrixLocEmpty(i)?r++:(p=p.concat(checkCluster(i,!1)),t=_.max(_.where(p,{row:0}),function(o){return o.num}),r=t.num+1);for(u=[],b=0;b<bubbleMatrix.length;){for(l=0;l<bubbleMatrix[b].length;)n={row:b,num:l},isMatrixLocEmpty(n)||0===_.where(p,n).length&&u.push(n),l++;b++}return drop(u,"drop"),e+=Math.ceil(1.5*u.length),$("#score").text(a+e)})):o.row>10&&($("#gameover").show(),gameover=!0,n=$(".point").last(),n.css("background-color","#DDD").css("border-color","#BBB"),n.putInMatrix(prevMatrixLoc),shooting=!1),i.length>=3&&(e+=i.length),a=parseInt($("#score").text()),$("#score").text(a+e)),shooting=!1},jQuery.fn.drawAt=function(o,t){$(this[0]).show().css("bottom",t+"px").css("left",+o+"px")},jQuery.fn.shoot=function(o){var t,r,e,n,a;return r=$(this[0]),clearInterval(window.shootInterval),n={row:"",num:""},e=$("#popper-container").outerHeight()-2*BUBBLE_RADIUS-2*BUBBLE_BORDER,a=0,t=0,window.shootInterval=setInterval(function(){var i,u,l;shooting=!0,l=getPointAtT(a,o),l.y<=e?(u=findClosestInMatrix(l.x,l.y),isMatrixLocEmpty(u)?(t%2===0&&r.drawAt(l.x,l.y),n=u,a+=SPEED):(clearInterval(window.shootInterval),r.putInMatrix(n))):(clearInterval(window.shootInterval),i=getPointAtY(e+BUBBLE_RADIUS,o),u=findClosestInMatrix(i.x,i.y),r.putInMatrix(isMatrixLocEmpty(u)?u:n))},5),r};